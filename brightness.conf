description "brightness - stores and restores the brightness of backlight devices"
author "Cameron Norman <camerontnorman@gmail.com>"

start on backlight-device-added
stop on runlevel [016]

instance $KERNEL
usage "KERNEL - backlight device"

env LUZ_DIR=/var/lib/backlight

console log

pre-start script
    # set and prepare the storage directory
    STORAGE="$LUZ_DIR/${KERNEL}"
    if [ ! -d "$STORAGE" ]; then
        mkdir -p "$STORAGE" || true
    fi

    # Determine upper and lower limits for brightness
    max="$(cat /sys/class/backlight/${KERNEL}/max_brightness)"
    min="$(( $max / 20 ))" # five percent of the max

    # initialize the saved value
    if [ -f "$STORAGE"/brightness ]; then
        saved="$(cat $STORAGE/brightness)"
        echo "Using saved value: $saved"
    else
        # fallback is half of the max
        saved="$(( $max / 2 ))"
        echo "Using fallback value: $saved"
    fi

    # Do not black the user's screen by having too low brightness
    if [ "$min" -gt "$saved" ]; then
        saved="$min"
        echo "Resetting saved value to minimum: $min"
    fi

    # Make sure the upper limit is not exceeded
    if [ "$saved" -gt "$max" ]; then
        saved="$max"
        echo "Resetting saved value to maximum: $max"
    fi

    # Finally, set the device's brightness
    echo "$saved" > /sys/class/backlight/"$KERNEL"/brightness
end script

post-stop script
    STORAGE="$LUZ_DIR/${KERNEL}"
    [ -d "$STORAGE" ] || mkdir -p "$STORAGE"
    cat /sys/class/backlight/"$KERNEL"/brightness > "$STORAGE"/brightness
end script
