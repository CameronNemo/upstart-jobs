# What is broken?

# The file /usr/bin/pg_ctlcluster needs to have the line
#     exec '/bin/sh', '-c', "exec $postgres $postmaster_opts"
# changed to:
#     exec '/bin/sh', '-c', "exec $postgres $postmaster_opts -D $info{'pgdata'}"

description "PostgreSQL - RDBMS server (cluster)"
author "Cameron Norman <camerontnorman@gmail.com>"

usage "VERSION - version of postgres, \
       CLUSTER - cluster within the version."
instance $VERSION-$CLUSTER

export VERSION
export CLUSTER

stop on (stop-postgresql-clusters VERSION=$VERSION
         or deconfiguring-networking
         or runlevel [016])

respawn
exec /usr/bin/pg_ctlcluster --foreground $VERSION $CLUSTER start >/var/log/postgresql/postgresql-$VERSION-$CLUSTER.log 2>&1

post-start script
	for t in $(seq 1 60); do
		sleep 0.25
		pg_ctlcluster $VERSION $CLUSTER status >/dev/null 2>&1 && exit 0
	done
	# None of the status calls succeeded
	echo "Postgres cluster failed to start."
	stop; exit 1
end script

kill timeout 45
pre-stop exec /usr/bin/pg_ctlcluster --force $VERSION $CLUSTER stop
