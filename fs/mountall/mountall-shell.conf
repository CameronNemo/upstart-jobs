# mountall-shell - Recovery shell for filesystem failure
#
# If mountall exits to indicate that manual recovery is required, this
# starts the necessary shell.

description	"Recovery shell for filesystem failure"

start on (stopped mountall EXIT_STATUS=[!4]
          or stopped mountall EXIT_SIGNAL=?*)
stop on runlevel [06]

task
console owner

script
    case "$EXIT_STATUS" in
    ""|1)
    	err="General error mounting filesystems."
	action="reboot the system."
	;;
    2)
    	err="Filesystem check or mount failed."
	action="continue boot, re-trying filesystems and ignoring further errors."
	;;
    3)
        err="Root filesystem check failed."
	action="reboot the system."
	;;
    esac

    echo "${err}"
    echo "A maintenance shell will now be started."
    echo "CONTROL-D will terminate this shell and ${action}"

    /sbin/sulogin
end script

post-stop script
    if [ -z "$UPSTART_STOP_EVENTS" ]
    then
	if [ "$EXIT_STATUS" = "2" ]
	then
	    exec start --no-wait mountall
	else
	    umount -a || :
	    exec reboot -f
	fi
    fi
end script
