description "OpenVPN - secure IP tunnel daemon"

# Manually started job; no "start on" stanza applicable
stop on deconfiguring-networking

instance $VPN
usage "VPN - VPN name with a matching conf file, /etc/openvpn/\$VPN.conf"

# TODO: readiness
respawn

chdir /etc/openvpn

env RUNDIR="/run/openvpn"
# Defaults in case they are not set in /etc/default/openvpn
env STATUSREFRESH=10
env OMIT_SENDSIGS=0

pre-start script
    if [ ! -r /etc/openvpn/$VPN.conf ]; then
        echo "Instance has no config file"
        # Change job goal to stop so we do not get respawned on !0 exit
        stop; exit 1
    fi

    # This should have been created in the openvpn-autostart job;
    # just double checking.
    [ -d $RUNDIR ] || mkdir -p $RUNDIR
end script

script
    [ ! -s /etc/default/openvpn ] || . /etc/default/openvpn
    STATUS="--status $RUNDIR/$VPN.status $STATUSREFRESH"
    test $STATUSREFRESH -ne 0 || STATUS=""

    exec /usr/sbin/openvpn --syslog ovpn-$VPN --config $VPN.conf $STATUS
end script

# Make sure status file isnot left behind
post-stop exec rm -f $RUNDIR/$VPN.status
